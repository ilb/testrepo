name: Update Version

on:
  push:
    branches:
      - master

jobs:
  update-version:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '14'

    - name: Install dependencies
      run: npm install

    - name: Get current date
      id: date
      run: echo "::set-output name=date::$(date +'%Y.%m.%d')"

    - name: Get current version
      id: current_version
      run: echo "::set-output name=version::$(node -e "console.log(require('./package.json').version)")"

    - name: Calculate new version
      id: new_version
      run: |
        CURRENT_VERSION=${{ steps.current_version.outputs.version }}
        CURRENT_DATE=${{ steps.date.outputs.date }}
        NEW_VERSION="${CURRENT_DATE}.$((${CURRENT_VERSION##*.} + 1))"
        echo "::set-output name=version::$NEW_VERSION"
    
    - name: Update package.json version
      run: |
        jq '.version = "${{ steps.new_version.outputs.version }}"' package.json > temp.json && mv temp.json package.json

    - name: Commit changes
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add package.json
        git commit -m "Update version to ${{ steps.new_version.outputs.version }}"
        git push
